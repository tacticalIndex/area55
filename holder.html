<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCP:RP Staff Shift Tracker</title>
  <style>
    :root {
      --bg: linear-gradient(to bottom right, #003478, #202A44);
      --panel: #121821;
      --panel-2: #0f141b;
      --text: #e6edf3;
      --muted: #9aa4af;
      --accent: #704D99;
      --ok: #2ea043;
      --warn: #e3b341;
      --border: #263041;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 10% 0%, #0d141c 0, var(--bg) 50%);
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0 0 6px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      max-width: 1000px;
      margin: 0 auto;
    }

    @media (min-width: 920px) {
      .grid {
        grid-template-columns: 1.1fr 0.9fr;
      }
    }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1.1rem;
      letter-spacing: .3px;
    }

    label {
      display: block;
      font-size: 0.9rem;
      color: var(--muted);
      margin: 10px 0 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0e1520;
      color: var(--text);
      outline: none;
      transition: border .15s ease;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > * {
      flex: 1;
    }

    .timer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      background: #0e141d;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .time {
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 2rem;
      letter-spacing: .5px;
    }

    .btns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: 1px solid var(--border);
      background: #132030;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    button.primary { background: #17314b; border-color: #25496b; }
    button.success { background: #12321f; border-color: #225f39; }
    button.warn    { background: #3a2c12; border-color: #72581d; }
    button.danger  { background: #3b161a; border-color: #6a272d; }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .stamp {
      font-size: .9rem;
      color: var(--muted);
    }

    .paste-slot {
      border: 1px dashed #3a4a63;
      border-radius: 12px;
      padding: 12px;
      background: #0c121a;
      position: relative;
    }

    .slot-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .slot-title {
      font-weight: 700;
    }

    .slot-actions {
      display: flex;
      gap: 8px;
    }

    .slot-body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 180px;
      background: #0b1118;
      border-radius: 10px;
      overflow: hidden;
    }

    .slot-body.empty::after {
      content: 'Click this area, then press Ctrl+V to paste a screenshot OR use Paste button';
      color: #7b8796;
      font-size: .95rem;
      text-align: center;
      padding: 12px;
      max-width: 460px;
    }

    canvas {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .footer {
      text-align: center;
      color: var(--muted);
      margin-top: 20px;
      font-size: .9rem;
    }

    .bar {
      height: 3px;
      background: linear-gradient(90deg, var(--accent), transparent);
      border-radius: 999px;
      margin: 10px 0 16px;
      opacity: .5;
    }

    .note {
      background: #131a25;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      color: var(--muted);
      font-size: .9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>In-Game Staff Shift Tracker</h1>
    <div>Created by tactical_index for the SCP: Roleplay custom server Area-55</div>
  </header>

  <div class="grid">
    <section class="card">
      <h2>Staff Details</h2>
      <div class="bar"></div>

      <label>Roblox Username</label>
      <input id="roblox" placeholder="Exact Roblox username" />

      <label>Discord Username</label>
      <input id="discord" placeholder="e.g. user#0001" />

      <label>Staff Codename</label>
      <input id="codename" placeholder="e.g. 'User'" />

      <label>Staff Team</label>
      <form id="shift-form">
        <select id="team">
          <option value="NONE">=== SELECT STAFF TEAM ===</option>
          <option value="SERVERSTARTUPDEPARTMENT">Server Startup Department</option>
          <option value="GAMEMODERATIONTEAM">Game Moderation Team</option>
          <option value="ACTINGDEPARTMENT">Acting Department</option>
          <option value="EVENTCOMMITTEE">Event Committee</option>
          <option value="MORPHINGDEPARTMENT">Morphing Department</option>
        </select>

        <div class="btns" style="margin-top:8px;">
          <button type="submit" class="primary">Send</button>
          <label id="status">Status</label>
        </div>
      </form>

      <h2>Stopwatch</h2>
      <div class="bar"></div>

      <div class="timer">
        <div>
          <div class="time" id="time">00:00:00</div>
          <div class="stamp" id="stamps">Start: — · End: —</div>
        </div>
        <div class="btns">
          <button id="startBtn" class="primary">Start</button>
          <button id="pauseBtn" class="warn" disabled>Pause</button>
          <button id="resumeBtn" class="primary" disabled>Resume</button>
          <button id="endBtn" class="success" disabled>End Shift</button>
          <button id="resetBtn" class="danger" disabled>Reset</button>
        </div>
      </div>
      <div class="note" style="margin-top:10px">
        • Start sets the official start time. Pause/Resume doesn’t change it. End Shift records the end time.<br />
        • Nothing is uploaded or saved; please ensure you do not accidentally reload your tab - your recorded data will not be saved.
      </div>

      <div style="height:12px"></div>
      <h2>Export</h2>
      The Shift Summary/Export will not include screenshots, send the shift summary by clicking the Send button below the textboxes.
      <div class="bar"></div>
      <div class="row">
        <button id="copySummary" class="primary">Copy Shift Summary</button>
      </div>
    </section>

    <section class="card">
      <h2>Shift Screenshots</h2>
      <div class="bar"></div>

      <div class="paste-slot" id="slotStart">
        <div class="slot-head">
          <div class="slot-title">Start Screenshot</div>
          <div class="slot-actions">
            <button data-paste="start">Paste</button>
            <button data-clear="start">Clear</button>
          </div>
        </div>
        <div class="slot-body empty" tabindex="0">
          <canvas id="canvasStart"></canvas>
        </div>
      </div>

      <div class="paste-slot" id="slotEnd" style="margin-top:12px;">
        <div class="slot-head">
          <div class="slot-title">End Screenshot</div>
          <div class="slot-actions">
            <button data-paste="end">Paste</button>
            <button data-clear="end">Clear</button>
          </div>
        </div>
        <div class="slot-body empty" tabindex="0">
          <canvas id="canvasEnd"></canvas>
        </div>
      </div>

      <div class="note" style="margin-top:12px">
        Screenshots will be uploaded automatically via Cloudinary before sending.
      </div>
    </section>
  </div>

  <div class="footer">Created by <strong>tactical_index</strong></div>

  <script>
    // ===== Stopwatch =====
    const timeEl = document.getElementById("time");
    const stampsEl = document.getElementById("stamps");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const resumeBtn = document.getElementById("resumeBtn");
    const endBtn = document.getElementById("endBtn");
    const resetBtn = document.getElementById("resetBtn");

    let startEpoch = null;
    let elapsed = 0;
    let running = false;
    let tick = null;
    let startStamp = null;
    let endStamp = null;

    function fmt(ms) {
      const total = Math.floor(ms / 1000);
      const h = String(Math.floor(total / 3600)).padStart(2, "0");
      const m = String(Math.floor((total % 3600) / 60)).padStart(2, "0");
      const s = String(total % 60).padStart(2, "0");
      return `${h}:${m}:${s}`;
    }

    function nowStamp() {
      const d = new Date();
      const z2 = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${z2(d.getMonth() + 1)}-${z2(d.getDate())} ${z2(d.getHours())}:${z2(d.getMinutes())}:${z2(d.getSeconds())}`;
    }

    function render() {
      const current = running ? Date.now() - startEpoch + elapsed : elapsed;
      timeEl.textContent = fmt(current);
      stampsEl.textContent = `Start: ${startStamp || "—"} · End: ${endStamp || "—"}`;
    }

    function setButtons(state) {
      startBtn.disabled = !(state === "idle");
      pauseBtn.disabled = !(state === "running");
      resumeBtn.disabled = !(state === "paused");
      endBtn.disabled = !(state === "running" || state === "paused");
      resetBtn.disabled = !(state === "paused" || state === "ended");
    }

    function start() {
      if (running) return;
      if (!startStamp) startStamp = nowStamp();
      startEpoch = Date.now();
      running = true;
      tick = setInterval(render, 250);
      setButtons("running");
      render();
    }

    function pause() {
      if (!running) return;
      running = false;
      clearInterval(tick);
      elapsed += Date.now() - startEpoch;
      setButtons("paused");
      render();
    }

    function resume() {
      start();
    }

    function endShift() {
      if (running) pause();
      if (!endStamp) endStamp = nowStamp();
      setButtons("ended");
      render();
    }

    function reset() {
      clearInterval(tick);
      startEpoch = null;
      elapsed = 0;
      running = false;
      startStamp = null;
      endStamp = null;
      timeEl.textContent = "00:00:00";
      setButtons("idle");
      render();
    }

    startBtn.addEventListener("click", start);
    pauseBtn.addEventListener("click", pause);
    resumeBtn.addEventListener("click", resume);
    endBtn.addEventListener("click", endShift);
    resetBtn.addEventListener("click", reset);

    setButtons("idle");
    render();

    // ===== Screenshot Slots =====
    const slotStart = { canvas: document.getElementById("canvasStart"), body: document.querySelector("#slotStart .slot-body"), blob: null };
    const slotEnd   = { canvas: document.getElementById("canvasEnd"), body: document.querySelector("#slotEnd .slot-body"), blob: null };
    let activeSlot = null;

    function drawBlobToCanvas(slot, blob) {
      const img = new Image();
      img.onload = () => {
        const maxWidth = 1000;
        const scale = Math.min(1, maxWidth / img.width);
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        slot.canvas.width = w;
        slot.canvas.height = h;
        const ctx = slot.canvas.getContext("2d");
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0, w, h);
        slot.body.classList.remove("empty");
      };
      img.src = URL.createObjectURL(blob);
      slot.blob = blob;
    }

    function handlePasteEvent(e) {
      if (!activeSlot) return;
      const items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (const it of items) {
        if (it.type.startsWith("image/")) {
          const blob = it.getAsFile();
          if (blob) {
            drawBlobToCanvas(activeSlot, blob);
            e.preventDefault();
            return;
          }
        }
      }
    }

    document.addEventListener("paste", handlePasteEvent);

    slotStart.body.addEventListener("click", () => { activeSlot = slotStart; slotStart.body.focus(); });
    slotEnd.body.addEventListener("click", () => { activeSlot = slotEnd; slotEnd.body.focus(); });

    document.querySelectorAll("[data-paste]").forEach(btn => {
      btn.addEventListener("click", async () => {
        try {
          if (!navigator.clipboard || !navigator.clipboard.read) {
            alert("Clipboard read not supported");
            return;
          }
          const items = await navigator.clipboard.read();
          for (const item of items) {
            for (const type of item.types) {
              if (type.startsWith("image/")) {
                const blob = await item.getType(type);
                const slot = btn.dataset.paste === "start" ? slotStart : slotEnd;
                drawBlobToCanvas(slot, blob);
                return;
              }
            }
          }
          alert("No image found in clipboard");
        } catch (err) {
          console.warn(err);
          alert("Clipboard paste failed");
        }
      });
    });

    document.querySelectorAll("[data-clear]").forEach(btn => {
      btn.addEventListener("click", () => {
        const slot = btn.dataset.clear === "start" ? slotStart : slotEnd;
        const ctx = slot.canvas.getContext("2d");
        ctx.clearRect(0, 0, slot.canvas.width, slot.canvas.height);
        slot.blob = null;
        slot.body.classList.add("empty");
      });
    });

    // ===== Build Shift Text =====
    function buildShiftLines() {
      const roblox = document.getElementById("roblox").value.trim() || "—";
      const discordUser = document.getElementById("discord").value.trim() || "—";
      const codename = document.getElementById("codename").value.trim() || "—";
      const team = document.getElementById("team").value;
      const duration = timeEl.textContent;
      const startTime = startStamp || "—";
      const endTime = endStamp || "—";

      return [
        `**__SCP:RP Shift Log__**`,
        `**Roblox:** ${roblox}`,
        `**Discord:** ${discordUser}`,
        `**Codename:** ${codename}`,
        `**Team:** ${team}`,
        `**Start:** ${startTime}`,
        `**End:** ${endTime}`,
        `**Duration:** ${duration}`
      ].join("\n");
    }

    function getBase64FromCanvas(slot) {
      if (!slot.blob) return null;
      return slot.canvas.toDataURL("image/png").split(",")[1];
    }

    // ===== Submit Handler =====
    document.getElementById("shift-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const statusDiv = document.getElementById("status");
      const sendBtn = e.target.querySelector("button[type=submit]");
      sendBtn.disabled = true;
      sendBtn.textContent = "Sending...";

      const payload = {
        embeds: [{
          title: "Shift Report", 
          description: buildShiftLines()
        }],
        username: "Shift Tracker Bot",
        footer: `${discordUser} • ${new Date().toLocaleString()}`
      };

      const body = {
        team: document.getElementById("team").value,
        payload: payload,
        startImage: getBase64FromCanvas(slotStart),
        endImage: getBase64FromCanvas(slotEnd)
      };

      try {
        const response = await fetch("/.netlify/functions/proxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          statusDiv.textContent = "✅ Message sent!";
          statusDiv.style.color = "lightgreen";
        } else {
          const err = await response.text();
          statusDiv.textContent = `❌ Error: ${err}`;
          statusDiv.style.color = "salmon";
        }
      } catch (err) {
        statusDiv.textContent = `⚠️ Failed: ${err.message}`;
        statusDiv.style.color = "salmon";
      }

      sendBtn.disabled = false;
      sendBtn.textContent = "Send";
    });
  </script>
</body>
</html>
